#include <stdio.h>
#include <unistd.h>

#include "layers/matrix.h"
#include "layers/lstm.h"
float lstm_1_kernel_weights[] = {-0.11138653755187988, 0.22896693646907806, -0.60296922922134399, 0.43992856144905090, 0.47826248407363892, 0.03746636584401131, -0.44716590642929077, 0.10910264402627945, 0.41209378838539124, -0.10412748157978058, 0.13623058795928955, -0.71828263998031616,};
struct matrix_f lstm_1_kernel = {.x=1, .y=12, .data=lstm_1_kernel_weights};
float lstm_1_recurrent_kernel_weights[] = {-0.26069098711013794, -0.20290280878543854, 0.21663579344749451, -1.03014004230499268, -0.19240644574165344, 0.22681766748428345, -0.07238705456256866, -0.39520812034606934, -0.21552993357181549, -0.44515779614448547, -0.62176918983459473, 0.47965675592422485, 0.22313055396080017, 0.37778404355049133, -0.45542836189270020, 0.17161339521408081, 0.16404472291469574, 0.03692549839615822, 0.01016489416360855, 0.03992509096860886, 0.34017980098724365, 0.08782042562961578, 0.00042673543794081, 0.35722169280052185, 0.12200673669576645, 0.38269796967506409, -0.61351704597473145, 0.44893917441368103, 0.14856140315532684, -0.58848321437835693, -0.02343891002237797, -0.38541454076766968, 0.23298323154449463, -0.23381271958351135, 0.29147616028785706, -0.61018073558807373,};
struct matrix_f lstm_1_recurrent_kernel = {.x=3, .y=12, .data=lstm_1_recurrent_kernel_weights};
float lstm_1_bias_weights[] = {0.10178969800472260, 0.36655518412590027, 0.11918659508228302, 1.09498453140258789, 1.25383174419403076, 1.10266816616058350, 0.13135625422000885, 0.08208376914262772, 0.19616332650184631, 0.38030767440795898, 0.38460430502891541, 0.17582342028617859,};
struct matrix_f lstm_1_bias = {.x=1, .y=12, .data=lstm_1_bias_weights};
struct lstm_layer lstm_1 = {.kernel=&lstm_1_kernel, .recurrent_kernel=&lstm_1_recurrent_kernel, .bias=&lstm_1_bias, .input_x=1, .input_y=1, .output_x=1, .output_y=3, .return_sequences=true};
float lstm_2_kernel_weights[] = {-0.11138653755187988, 0.22896693646907806, -0.60296922922134399, 0.43992856144905090, 0.47826248407363892, 0.03746636584401131, -0.44716590642929077, 0.10910264402627945, 0.41209378838539124, -0.10412748157978058, 0.13623058795928955, -0.71828263998031616,};
struct matrix_f lstm_2_kernel = {.x=1, .y=12, .data=lstm_2_kernel_weights};
float lstm_2_recurrent_kernel_weights[] = {-0.26069098711013794, -0.20290280878543854, 0.21663579344749451, -1.03014004230499268, -0.19240644574165344, 0.22681766748428345, -0.07238705456256866, -0.39520812034606934, -0.21552993357181549, -0.44515779614448547, -0.62176918983459473, 0.47965675592422485, 0.22313055396080017, 0.37778404355049133, -0.45542836189270020, 0.17161339521408081, 0.16404472291469574, 0.03692549839615822, 0.01016489416360855, 0.03992509096860886, 0.34017980098724365, 0.08782042562961578, 0.00042673543794081, 0.35722169280052185, 0.12200673669576645, 0.38269796967506409, -0.61351704597473145, 0.44893917441368103, 0.14856140315532684, -0.58848321437835693, -0.02343891002237797, -0.38541454076766968, 0.23298323154449463, -0.23381271958351135, 0.29147616028785706, -0.61018073558807373,};
struct matrix_f lstm_2_recurrent_kernel = {.x=3, .y=12, .data=lstm_2_recurrent_kernel_weights};
float lstm_2_bias_weights[] = {0.10178969800472260, 0.36655518412590027, 0.11918659508228302, 1.09498453140258789, 1.25383174419403076, 1.10266816616058350, 0.13135625422000885, 0.08208376914262772, 0.19616332650184631, 0.38030767440795898, 0.38460430502891541, 0.17582342028617859,};
struct matrix_f lstm_2_bias = {.x=1, .y=12, .data=lstm_2_bias_weights};
struct lstm_layer lstm_2 = {.kernel=&lstm_2_kernel, .recurrent_kernel=&lstm_2_recurrent_kernel, .bias=&lstm_2_bias, .input_x=1, .input_y=1, .output_x=1, .output_y=3, .return_sequences=false};

int main() {
	float input_data[] = {0.003};
	float input_data_2[] = {0.002};
	float input_data_3[] = {1};
	struct matrix_f input_mat = {.x=1, .y=1, .data=input_data};
	struct matrix_f input_mat_2 = {.x=1, .y=1, .data=input_data_2};
	struct matrix_f input_mat_3 = {.x=1, .y=1, .data=input_data_3};
	
	struct lstm_sequence_io_node input_3 = {.next=NULL, .data=&input_mat_3};
	struct lstm_sequence_io_node input_2 = {.next=&input_3, .data=&input_mat_2};
	struct lstm_sequence_io_node input = {.next=&input_2, .data=&input_mat};
	//struct lstm_sequence_io_node input = {.next=NULL, .data=&input_mat};
	
	struct lstm_sequence_io_node result = {0};
	//struct lstm_sequence_io_node result_2 = {0};
	result = LSTMLayer(lstm_1, &input);
	//result_2 = LSTMLayer(lstm_2, &result);
	usleep(5); //Used as a breakpoint.
	struct lstm_sequence_io_node *p = &result;

	while(p != NULL) {
		print_mat(*(p->data));
		p = p->next;
	}
}